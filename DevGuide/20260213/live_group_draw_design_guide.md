# 라이브 조편성 애니메이션(추첨) 기능 설계 가이드
> Next.js + Supabase + Vercel 기반 / PC·모바일 동시 시청 / 실시간 동기화  
> 현재 구현 방식: **룰렛(Roulette) 추첨**  
> 목표: 추후 **핀볼/로또/카드/슬롯** 등 다른 연출로 확장 가능한 구조

---

## 0. 개요

골프 대회 참가 신청이 완료된 후, 관리자가 조편성(예: 40명 → 10개조 × 4명)을 진행한다.  
이 조편성 과정을 단순 결과 표시가 아니라 **라이브 애니메이션(게임 같은 연출)**으로 보여주고, 로그인한 일반 사용자(시청자)들이 **실시간으로 동일한 화면 흐름**을 공유하도록 한다.

핵심 요구사항:
- **실시간 시청**: PC/모바일 모두에서 라이브로 같은 과정을 본다.
- **스텝 진행(1명씩)**: N명 중 1명 뽑고 → 남은 N-1에서 다음 뽑기… 누적 진행
- **조 배정 포함**: 뽑힌 사람이 어느 조에 들어가는지까지 “과정”으로 보여준다.
- **기본 배정은 자동 추천(라운드로빈)**, 진행자가 확정/변경 가능
- **추가 기능**: “이번 추첨은 특정 조 자리를 채운다(타겟 조 지정)” 모드 지원
- **확장성**: 현재는 룰렛이지만, 추후 다른 애니메이션 방식도 끼워 넣을 수 있는 구조

비-요구사항(현재 문서 범위):
- 엄격한 암호화/커밋-리빌 같은 고보안 설계(불필요)
- 불특정 다수 공개 스트리밍(유튜브 라이브 같은 영상 송출)

---

## 1. 용어 정리

- **진행자(관리자)**: 조편성 라이브 세션을 시작/진행하는 사람(권한 있음)
- **시청자(일반 사용자)**: 라이브 화면을 보는 로그인 사용자(읽기 전용)
- **세션(Session)**: 특정 대회의 조편성 라이브 진행 단위
- **스텝(Step)**: “한 명 뽑기 + 조 배정 확정”까지의 1회 진행 단위
- **remaining pool**: 아직 배정되지 않은 참가자 목록
- **groups**: 조별 멤버 목록(누적)
- **연출(Animator)**: 룰렛/핀볼 등 “뽑는 과정”을 보여주는 클라이언트 렌더링 모듈

---

## 2. 전체 아키텍처(템플릿)

### 2.1 기술 스택(기본)
- **Frontend**: Next.js (App Router 권장)
- **Hosting**: Vercel
- **Auth/DB/Realtime**: Supabase
  - Postgres (조편성 세션/이벤트 로그/결과 저장)
  - Realtime (Broadcast로 이벤트 실시간 공유)
  - RLS (진행자/시청자 권한 분리)

### 2.2 “영상 스트리밍”이 아닌 “이벤트 스트리밍”
이 기능은 동영상을 송출하지 않는다.  
서버/DB는 **이벤트(무슨 일이 일어났는지)**만 실시간으로 전파하고, 각 클라이언트는 이벤트를 받아 **자신의 화면에서 애니메이션을 재생**한다.

- 서버(백엔드 권한 주체): 결과/상태를 저장하고, 이벤트를 발행
  - Next.js API Route/Server Action 또는 Supabase Edge Function
- 클라이언트(진행자/시청자): 받은 이벤트를 기준으로 화면/애니메이션 렌더링

### 2.3 동기화 원칙
- 모든 사용자 화면이 같은 흐름을 보려면, 이벤트에 다음이 포함되어야 한다.
  - `step`(몇 번째인지)
  - `startedAt`(기준 시간)
  - `durationMs`(연출 길이)
  - `payload`(결과: 뽑힌 사람, 타겟 조 등)

클라이언트는 `startedAt`을 기준으로 재생 타이밍을 맞춘다.
- 늦게 들어온 사용자는 이벤트 로그를 리플레이하여 현재 상태로 따라붙는다.

---

## 3. 데이터/이벤트 중심 설계(템플릿)

### 3.1 핵심 데이터 모델(권장)
- **draw_sessions**: 세션 메타(대회/인원/조 규칙/상태)
- **draw_events**: 이벤트 로그(스텝 진행 기록)
- (선택) **draw_state_snapshots**: 빠른 로딩을 위한 스냅샷(규모 커지면 도입)

> 초기 구현은 “이벤트 로그 리플레이” 방식이 단순하고 확장에 유리하다.

### 3.2 이벤트 타입(템플릿)
이벤트는 “연출 방식(룰렛/핀볼 등)”과 무관하게 공통된 흐름을 가진다.

권장 공통 타입:
- `SESSION_STARTED`
- `STEP_CONFIGURED` (이번 스텝의 모드/타겟 조/타이밍)
- `PICK_RESULT` (이번 스텝의 당첨자)
- `ASSIGN_UPDATED` (확정 전 조 변경)
- `ASSIGN_CONFIRMED` (조 배정 확정)
- (옵션) `MEMBER_MOVED` (확정 후 재편성)
- (옵션) `UNDO_LAST` (되돌리기)

> “연출 방식 확장성”은 이벤트 타입을 고정하고, **Animator만 교체 가능**하게 만드는 것으로 확보한다.

---

## 4. 권한/역할 설계(템플릿)

### 4.1 권한 분리
- 시청자: 세션/이벤트/결과 읽기, Realtime 구독 가능
- 진행자: 이벤트 발행, 확정/수정 가능

Supabase RLS 권장 방향:
- `draw_sessions`, `draw_events`는 기본적으로 읽기 허용(로그인 사용자)
- 쓰기(insert/update)는 진행자(대회 관리자)만 허용
- Realtime Broadcast는 채널 구독은 로그인 사용자, 발행은 진행자만 하도록 정책 설계

---

## 5. UI 구조(템플릿)

### 5.1 라우팅
- 진행자 페이지: `/tournaments/:id/draw/admin`
- 시청자 페이지: `/tournaments/:id/draw`

### 5.2 화면 레이아웃(권장)
공통(시청자/진행자):
- 중앙: 애니메이션(룰렛/핀볼 등)
- 한쪽: 조별 박스(1조~10조) + 멤버 카드 누적
- 상단: 현재 진행(예: 17/40), 현재 모드/타겟 조
- 하단(진행자만): 컨트롤 패널

진행자 컨트롤:
- 다음 스텝 시작
- 모드 선택(라운드로빈/타겟 조 지정)
- 타겟 조 드롭다운(타겟 모드 시)
- 확정/조 변경/되돌리기

---

## 6. 확장성 설계: “Animator 플러그인 구조”(템플릿)

### 6.1 핵심 아이디어
비즈니스 로직(세션/스텝/확정/이벤트)은 고정하고,
연출만 교체 가능하도록 **Animator 인터페이스**를 둔다.

### 6.2 Animator 인터페이스(예시)
- 입력: `STEP_CONFIGURED`, `PICK_RESULT` 등 이벤트 payload
- 출력: 화면 애니메이션 재생(연출 종료 시 콜백)

예:
- `startStep(config)` → 룰렛 준비/시작
- `revealPick(result)` → 룰렛 멈추고 당첨자 표시
- `finish()` → 카드 이동/조 박스 반영 애니메이션 종료

이 구조면 추후 다음 구현체를 쉽게 추가 가능:
- `RouletteAnimator`
- `PinballAnimator`
- `LottoAnimator`
- `CardFlipAnimator`

---

# 7. 현재 선택 구현: 룰렛 방식 조편성(구체 설계)

## 7.1 목적/동작 요약
- 매 스텝마다 remaining pool에서 1명을 뽑는다.
- 뽑힌 사람을 특정 조에 배정한다.
- 배정은 기본 “자동 추천”이 있으며, 진행자가 확정/변경 가능하다.
- 자동 추천은 기본적으로 라운드로빈 형태.

## 7.2 조편성 룰(기본값 예)
- 참가자: 40명
- 조 수: 10개조
- 조당 인원: 4명
- 진행: 총 40스텝(1명씩)

## 7.3 스텝 모드 2종
### A) ROUND_ROBIN (자동 추천)
- 타겟 조는 라운드로빈으로 자동 산출
- 추천 공식(스텝 기준):
  - `targetGroup = (step % groupCount) + 1`

### B) TARGET_GROUP (진행자 지정 타겟 조)
- 진행자가 “이번 스텝은 N조 자리”를 먼저 선택
- 그 다음 remaining pool에서 1명을 뽑는다
- 기본 배정은 해당 타겟 조로 들어간다(진행자 변경 가능)

> 방송/시청 경험상 “지금은 7조 자리 추첨입니다”가 먼저 보여서 이해가 매우 쉬워진다.

---

## 7.4 룰렛 구현 기술 추천
### 룰렛(가벼운/안정적인 선택)
- `react-custom-roulette` (React/Next.js에 붙이기 쉬움)
- 혹은 Canvas 기반(커스텀)로 진행

권장 조합:
- 룰렛: `react-custom-roulette`
- 조 배정 연출: “카드 이동 애니메이션” (CSS transform 기반)
- 실시간: Supabase Realtime Broadcast

모바일 대응:
- 룰렛은 대체로 문제 없음
- 조 박스는 모바일에서 2열 그리드로 배치 권장
- 애니메이션은 기본 30~60fps, 저사양 모드(이펙트 최소화) 옵션 제공 가능

---

## 7.5 이벤트 흐름(룰렛용)
### 1) 세션 시작
- 진행자: SESSION_STARTED 발행
- 시청자: 이벤트 로그 리플레이 + 실시간 구독 시작

### 2) 스텝 시작(구성)
- 진행자:
  - 모드 선택(ROUND_ROBIN / TARGET_GROUP)
  - (타겟 모드면) 타겟 조 선택
  - STEP_CONFIGURED 발행  
    - payload 예: `{ step, mode, targetGroupNo, startedAt, durationMs }`

### 3) 룰렛 연출
- 클라이언트(모두):
  - STEP_CONFIGURED 수신 후 룰렛을 “startedAt 기준”으로 시작

### 4) 당첨자 공개
- 진행자/서버:
  - remaining pool에서 1명 선정
  - PICK_RESULT 발행: `{ step, playerId }`
- 클라이언트:
  - 룰렛 멈춤 + 당첨자 표시

### 5) 조 배정 확정
- 기본값: `targetGroupNo`(자동 추천 또는 지정값)
- 진행자:
  - 변경 시 ASSIGN_UPDATED 발행
  - 확정 시 ASSIGN_CONFIRMED 발행: `{ step, playerId, groupNo }`
- 클라이언트:
  - 당첨자 카드가 해당 조 박스로 이동하는 연출 실행
  - remaining에서 제거, groups에 추가

---

## 7.6 상태 관리(프론트/백 공통 개념)
### 상태(개념)
- `remainingPlayerIds`
- `groups[groupNo] = playerIds[]`
- `currentStep`
- `currentPick`(현재 뽑힌 사람)
- `phase`: `idle | configured | spinning | picked | confirmed | finished`

### 상태 생성 방식(권장)
- 최초 진입 시 DB에서 세션 + 이벤트 목록 조회
- 이벤트 로그를 순서대로 적용(reducer)해 현재 상태 계산
- 이후 Realtime 이벤트는 실시간으로 reducer에 적용

---

## 7.7 운영 UI(진행자) 설계 포인트
- “다음 스텝 시작” 버튼은 **STEP_CONFIGURED**를 발행하는 버튼
- 타겟 모드에서는 “타겟 조” 선택 후 시작 가능
- PICK_RESULT는
  - 진행자가 직접 “뽑기” 버튼으로 발생시키거나
  - STEP_CONFIGURED 후 자동(서버 타이머)으로 발생시키는 방식 중 선택
- 확정 전 조 변경은 드롭다운/드래그로 제공 가능
- (옵션) 되돌리기/재추첨은 운영 정책에 따라 제한 가능

---

## 7.8 시청자 UX(권장)
- 상단: “현재는 X조 자리 추첨(자동/지정)” + `n/total`
- 중앙: 룰렛 연출
- 우측/하단: 10개조 박스 누적 결과
- “라이브 / 리플레이” 전환:
  - 늦게 들어온 사용자는 최신 상태로 점프하거나, 빠른 리플레이 후 라이브 합류

---

## 8. 구현 로드맵(권장 순서)

1) **DB 스키마 + RLS** (세션/이벤트 테이블, 권한 분리)
2) **Realtime 채널** (대회별/세션별 room)
3) **이벤트 리플레이 reducer** (프론트 공통 상태 생성)
4) **시청자 페이지** (라이브 구독 + 조 박스 렌더)
5) **진행자 페이지** (STEP_CONFIGURED / PICK_RESULT / ASSIGN_CONFIRMED 발행)
6) **룰렛 Animator** 연결
7) **카드 이동 애니메이션**(조 배정 연출) 추가
8) (선택) 되돌리기/재편성/저사양 모드

---

## 9. 확장 아이디어(차후)
- **PinballAnimator**: 공이 떨어져 버킷(조)로 들어가는 연출(결과는 동일 이벤트로 동기화)
- **CardFlipAnimator**: 카드 덱에서 한 장씩 뽑아 조에 배정
- **SlotAnimator**: 슬롯머신으로 당첨자 표시
- 조편성 제약(핸디/성별/동반자 회피 등) 추가 시:
  - 이벤트/상태 모델은 유지
  - PICK_RESULT 후보군 산정 로직만 확장

---

## 10. 체크리스트(완성 기준)

- [ ] 시청자/진행자 모두 동일한 스텝 진행 흐름을 본다
- [ ] remaining pool이 스텝마다 감소한다
- [ ] 조 박스에 누적되며, 자동 추천(라운드로빈)과 타겟 조 지정이 모두 동작한다
- [ ] 진행자가 확정/변경할 수 있다
- [ ] 모바일에서도 페이지 레이아웃과 애니메이션이 무리 없이 동작한다
- [ ] 이벤트 로그 리플레이로 늦게 들어온 시청자도 상태를 복원한다
- [ ] Animator 교체 가능한 구조(인터페이스/추상화)가 준비되어 있다
